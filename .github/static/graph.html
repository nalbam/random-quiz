<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/static/favicon.ico">
  <title>k8s-usage</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/css/bootstrap.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />
</head>

<body>
  <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" href="#">k8s usage</a>
  </header>

  <div class="container-fluid">
    <div class="row">
      <main class="col-md-12 ms-sm-auto col-lg-12 px-md-4">
        <div
          class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Dashboard</h1>
          <div class="btn-toolbar mb-3 mb-md-0">
            <div class="row">
              <div class="col">
                <select id="cluster" name="cluster" class="form-select usage-form">
                </select>
              </div>
              <div class="col">
                <select id="type" name="type" class="form-select usage-form">
                  <option value="h">hourly</option>
                  <option value="d">daily</option>
                  <option value="w">weekly</option>
                  <option value="m">monthly</option>
                </select>
              </div>
              <div class="col">
                <div class="input-group date" data-provide="datepicker" data-date-format="yyyymmdd">
                  <input type="text" id="start" name="start" class="form-control usage-form datepicker">
                  <div class="input-group-addon">
                    <span class="glyphicon glyphicon-th"></span>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="input-group date" data-provide="datepicker" data-date-format="yyyymmdd">
                  <input type="text" id="end" name="end" class="form-control usage-form datepicker">
                  <div class="input-group-addon">
                    <span class="glyphicon glyphicon-th"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <canvas class="my-4 w-100" id="usage-chart" width="900" height="380"></canvas>
      </main>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
  <script>
    let chart;

    let cluster, type, start, end;

    $(document).ready(function () {
      cluster = getParam('cluster');
      type = getParam('type');
      start = getParam('start');
      end = getParam('end');

      if (!type) type = 'd';

      console.log(`cluster: ${cluster}, type: ${type}, start: ${start}, end: ${end}`);

      getTypes();

      chart = new Chart($('#usage-chart'), {
        type: 'line',
        data: {
          labels: [],
          datasets: []
        },
        options: {
          // responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              stackWeight: 2
            },
            y2: {
              beginAtZero: true,
              stackWeight: 1
            },
            y2: {
              beginAtZero: true,
              stackWeight: 1
            }
          }
        }
      });

      $('.usage-form').change(function () {
        getGraph();
      });
    });

    function getParam(n) {
      // console.log(location.search);
      let v;
      location.search
        .substr(1)
        .split('&')
        .forEach(function (x) {
          let a = x.split('=');
          if (a[0] === n) v = decodeURIComponent(a[1]);
        });
      return v;
    }

    function getTypes() {
      $.ajax({
        url: '/api/types',
        type: 'GET',
        success: function (data) {
          // console.log(data);
          $.each(data.clusters, function (i, item) {
            $('#cluster').append($('<option>', {
              value: item.name,
              text: item.name
            }));
          });
          if (cluster) $('#cluster').val(cluster);
          if (type) $('#type').val(type);
          if (start) $('#start').val(start);
          if (end) $('#end').val(end);
          getGraph();
        }
      });
    }

    function getGraph() {
      cluster = $('#cluster').val();
      type = $('#type').val();
      start = $('#start').val();
      end = $('#end').val();

      let dateList = [];
      let minList = [];
      let maxList = [];
      let sumList = [];
      let rateList = [];

      $.ajax({
        url: `/api/${cluster}/${type}`,
        type: 'get',
        data: { start: start, end: end },
        dataType: 'json',
        success: function (data) {
          // console.log(data);

          $('#start').val(data.start);
          $('#end').val(data.end);

          $.each(data.result, function (i, item) {
            dateList.push(item.date);
            minList.push(item.min);
            maxList.push(item.max);
            sumList.push(item.summery);
            rateList.push(item.rate);
          });

          chart.data.labels = dateList;
          chart.data.datasets = [
            {
              label: 'min',
              data: minList,
              borderColor: 'rgb(54, 162, 235)'
            },
            {
              label: 'max',
              data: maxList,
              borderColor: 'rgb(255, 99, 132)'
            },
            {
              label: 'summery',
              data: sumList,
              borderColor: 'rgb(255, 159, 64)',
              yAxisID: 'y2'
            },
            {
              label: 'rate',
              data: rateList,
              borderColor: 'rgb(153, 102, 255)',
              yAxisID: 'y3'
            }
          ];
          chart.update();
        }
      });
    }
  </script>
</body>

</html>
